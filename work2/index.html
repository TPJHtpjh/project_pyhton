<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>用户认证</title>
    <!-- 引入React库 -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <!-- 引入React DOM库 -->
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- 引入Babel编译器，用于转换JSX语法 -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- 引入Axios库 -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f0f2f5;
            margin: 0;
        }

        .form-container {
            background: white;
            padding: 2em;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 320px;
            text-align: center;
        }

        h2 {
            color: #333;
        }

        .input-group {
            margin-bottom: 1em;
            text-align: left;
        }

        label {
            font-weight: bold;
            display: block;
            margin-bottom: 0.5em;
        }

        input {
            width: 100%;
            padding: 0.8em;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        button {
            width: 100%;
            padding: 0.8em;
            border: none;
            background-color: #007bff;
            color: white;
            border-radius: 4px;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        button:hover {
            background-color: #0056b3;
        }

        .error-text {
            color: #dc3545;
            font-size: 0.8em;
            height: 1em;
            display: block;
            margin-top: 4px;
        }

        .link {
            color: #007bff;
            cursor: pointer;
            text-decoration: underline;
            margin-top: 1em;
            display: inline-block;
        }

        .success-text {
            color: #28a745;
            background-color: #d4edda;
            padding: 0.5em;
            border-radius: 4px;
            margin-bottom: 1em;
        }
    </style>
</head>

<body>
    <div id="root"></div>
    <script type="text/babel">
        const apiClient = axios.create({
            baseURL: 'http://127.0.0.1:8000',
            headers: { 'Content-Type': 'application/json' },
        });

        const { useState, useEffect } = React;

        // --- 登录组件 ---
        function LoginForm({ onNavigateToRegister, onLoginSuccess }) {
            const [account, setAccount] = useState("");
            const [password, setPassword] = useState("");
            const [accountError, setAccountError] = useState("");
            const [passwordError, setPasswordError] = useState("");
            const [generalError, setGeneralError] = useState("");

            const handleLogin = async () => {
                setAccountError("");
                setPasswordError("");
                setGeneralError("");

                let isValid = true;
                if (!account.trim()) { setAccountError('用户名不能为空'); isValid = false; }
                if (!password.trim()) { setPasswordError('密码不能为空'); isValid = false; }
                if (!isValid) return;

                try {
                    const response = await apiClient.get('/user/log_in', {
                        params: { username_or_email: account, password }
                    });
                    const result = response.data;
                    localStorage.setItem('token', result.access_token);
                    alert('登录成功！');
                    onLoginSuccess(result.user_id); // 调用父组件的回调函数
                } catch (error) {
                    setGeneralError(error.response?.data?.detail || '登录失败');
                }
            };

            return (
                <div className="form-container">
                    <h2>用户登入</h2>
                    {generalError && <p className="error-text" style={{ textAlign: 'center', backgroundColor: '#f8d7da', padding: '0.5em' }}>{generalError}</p>}
                    <div className="input-group">
                        <label>用户名/邮箱</label>
                        <input type="text" value={account} onChange={(e) => setAccount(e.target.value)} />
                        <span className="error-text">{accountError}</span>
                    </div>
                    <div className="input-group">
                        <label>密码</label>
                        <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} />
                        <span className="error-text">{passwordError}</span>
                    </div>
                    <button onClick={handleLogin}>登入</button>
                    <div className="link" onClick={onNavigateToRegister}>还没有账户？立即注册</div>
                </div>
            );
        }

        // --- 注册组件 ---
        function RegisterForm({ onNavigateToLogin }) {
            const [username, setUsername] = useState("");
            const [email, setEmail] = useState("");
            const [password, setPassword] = useState("");
            const [confirmPassword, setConfirmPassword] = useState("");

            const [usernameError, setUsernameError] = useState("");
            const [emailError, setEmailError] = useState("");
            const [passwordError, setPasswordError] = useState("");
            const [confirmError, setConfirmError] = useState("");
            const [generalError, setGeneralError] = useState("");
            const [success, setSuccess] = useState("");

            const handleSignup = async () => {
                // 重置错误信息
                setUsernameError("");
                setEmailError("");
                setPasswordError("");
                setConfirmError("");
                setGeneralError("");
                setSuccess("");

                // 前端验证
                let isValid = true;
                if (username.length < 3 || username.length > 20) { setUsernameError('用户名需3-20字符'); isValid = false; }
                if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { setEmailError('邮箱格式不正确'); isValid = false; }
                if (!/^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{8,}$/.test(password)) { setPasswordError('密码至少8位且含字母和数字'); isValid = false; }
                if (password !== confirmPassword) { setConfirmError('两次输入的密码不一致'); isValid = false; }
                if (!isValid) return;

                try {
                    await apiClient.post('/user/register', null, {
                        params: { username, email, password }
                    });
                    setSuccess("注册成功！");
                    alert("注册成功！即将跳转到登录页。");
                    onNavigateToLogin();
                } catch (error) {
                    if (error.response && error.response.status === 409) {
                        const wantsToLogin = window.confirm('该用户名或邮箱已存在，是否要直接登录？');
                        if (wantsToLogin) {
                            onNavigateToLogin();
                        }
                    } else {
                        setGeneralError(error.response?.data?.detail || '注册失败，请稍后重试');
                    }
                }
            };

            return (
                <div className="form-container">
                    <h2>创建账户</h2>
                    {generalError && <p className="error-text" style={{ textAlign: 'center', backgroundColor: '#f8d7da', padding: '0.5em' }}>{generalError}</p>}
                    {success && <p className="success-text">{success}</p>}
                    <div className="input-group">
                        <label>用户名</label>
                        <input type='text' value={username} onChange={(e) => setUsername(e.target.value)} />
                        <span className='error-text'>{usernameError}</span>
                    </div>
                    <div className="input-group">
                        <label>邮箱</label>
                        <input type='email' value={email} onChange={(e) => setEmail(e.target.value)} />
                        <span className='error-text'>{emailError}</span>
                    </div>
                    <div className="input-group">
                        <label>密码</label>
                        <input type='password' value={password} onChange={(e) => setPassword(e.target.value)} />
                        <span className='error-text'>{passwordError}</span>
                    </div>
                    <div className="input-group">
                        <label>确认密码</label>
                        <input type='password' value={confirmPassword} onChange={(e) => setConfirmPassword(e.target.value)} />
                        <span className='error-text'>{confirmError}</span>
                    </div>
                    <button onClick={handleSignup}>注册</button>
                    <div className="link" onClick={onNavigateToLogin}>已有账户？返回登录</div>
                </div>
            );
        }

        // --- 个人资料页组件 ---
        function ProfilePage({ userId, onLogout }) {
            const [profile, setProfile] = useState(null);
            const [error, setError] = useState(null);

            useEffect(() => {
                if (!userId) return;

                const fetchUser = async () => {
                    setError(null);
                    setProfile(null); // 开始获取前重置状态
                    try {
                        const response = await apiClient.get('/user/profile', {
                            params: { user_id: userId }
                        });
                        setProfile(response.data); // 将获取到的数据存入 state
                    } catch (err) {
                        setError(err.response?.data?.detail || '获取用户信息失败');
                    }
                };

                fetchUser();
            }, [userId]); // 当 userId 变化时重新运行

            const handleLogout = () => {
                localStorage.removeItem('token');
                onLogout();
            };

            if (error) {
                return (
                    <div className="form-container">
                        <h2>用户资料</h2>
                        <p className="error-text" style={{ textAlign: 'center' }}>{error}</p>
                        <button onClick={handleLogout}>返回登录</button>
                    </div>
                );
            }

            if (!profile) {
                return (
                    <div className="form-container">
                        <h2>用户资料</h2>
                        <p>正在加载...</p>
                    </div>
                );
            }

            return (
                <div className="form-container">
                    <h2>用户资料</h2>
                    <div>
                        <p><b>用户名:</b> {profile.username}</p>
                        <p><b>用户ID:</b> {profile.id}</p>
                        <p><b>邮箱:</b> {profile.email}</p>
                    </div>
                    <button onClick={handleLogout} style={{ marginTop: '1em' }}>登出</button>
                </div>
            );
        }

        // --- 主应用组件，用于切换页面 ---
        function App() {
            const [currentView, setCurrentView] = useState('login');
            const [userId, setUserId] = useState(null);

            const handleLoginSuccess = (id) => {
                setUserId(id);
                setCurrentView('profile');
            };

            const handleLogout = () => {
                setUserId(null);
                setCurrentView('login');
            };

            const renderView = () => {
                switch (currentView) {
                    case 'profile':
                        return <ProfilePage userId={userId} onLogout={handleLogout} />;
                    case 'register':
                        return <RegisterForm onNavigateToLogin={() => setCurrentView('login')} />;
                    case 'login':
                    default:
                        return <LoginForm
                            onNavigateToRegister={() => setCurrentView('register')}
                            onLoginSuccess={handleLoginSuccess}
                        />;
                }
            };

            return (
                <div>
                    {renderView()}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById("root"));
        root.render(<App />);
    </script>
</body>

</html>